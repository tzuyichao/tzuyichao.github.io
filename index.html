<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Java幼幼園">
<meta property="og:type" content="website">
<meta property="og:title" content="Expert Beginner">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Expert Beginner">
<meta property="og:description" content="Java幼幼園">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Terence Chao">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-TW'
  };
</script>

  <title>Expert Beginner</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Expert Beginner</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Java幼幼園</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/13/java-instrumentation-hello-javaagent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terence Chao">
      <meta itemprop="description" content="Java幼幼園">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Expert Beginner">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/13/java-instrumentation-hello-javaagent/" class="post-title-link" itemprop="url">Java instrumentation - hello javaagent</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-09-13 11:25:51" itemprop="dateCreated datePublished" datetime="2020-09-13T11:25:51+08:00">2020-09-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-09-14 14:33:00" itemprop="dateModified" datetime="2020-09-14T14:33:00+08:00">2020-09-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>想直接看程式碼<a target="_blank" rel="noopener" href="https://github.com/tzuyichao/java-basic/tree/master/instrumentation/hello-javaagent">hello-javaagent Project</a>、<a target="_blank" rel="noopener" href="https://github.com/tzuyichao/java-basic/tree/master/instrumentation/hello-attach">hello-attach Project</a>的話，直接點連結即可。</p>
<p>hello-javaagent Project講用<code>-javaagent</code>的方式使用java instrumentation的hello world project。這是個multi module maven project。有兩個module一個是client一個是agent部分。另外，還有一個run.xml的ant script裡面有兩個task用來執行client，一個task有啟動agent一個沒有，可以感覺一下差異。</p>
<p>hello-attach project則是使用attach的方式，有三個project，client subproject是用spring boot寫的client，attach subproject是用來attach agent jar到target jvm，最後agent subproject是agent的本體。</p>
<h3 id="Java-Instrumentation"><a href="#Java-Instrumentation" class="headerlink" title="Java Instrumentation"></a>Java Instrumentation</h3><p>Instrumentation讓我們可以在既有（compiled)方法插入額外的bytecode，而達到收集使用中資料來進一步分析使用。instrumentation底層是透過<code>JVM Tool Interface</code>(<code>JVMTI</code>)來達成，JVMTI是JVM暴露出來的extension point。</p>
<p>在Java 5的時候讓我們可以在啟動的時候使用<code>-javaagent</code>的方式，指定agent。在Java 6的時候則更近一步提供了attach的方式，讓我們可以針對已啟動的JVM process執行agent的工作。</p>
<ul>
<li>啟動JVM時啟動代理 (hello-javaagent project)</li>
<li>針對已啟動JVM啟動代理 (hello-attach project)</li>
</ul>
<h3 id="hello-javaagent"><a href="#hello-javaagent" class="headerlink" title="hello-javaagent"></a>hello-javaagent</h3><h4 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h4><p>入口class我們要提供<code>premain()</code>這個方法，需要兩個參數</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span></span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>第一個參數是啟動agent時，可以由命令列給予agent的參數，第二個則是JVM會提供agent class使用的Instrumentation的入口。</p>
<h4 id="Instrumentation-Interface"><a href="#Instrumentation-Interface" class="headerlink" title="Instrumentation Interface"></a>Instrumentation Interface</h4><ul>
<li>void addTransformer(ClassFileTransformer transformer, boolean canRetransform)</li>
</ul>
<p>註冊transformer</p>
<ul>
<li>Class[] getAllLoadedClasses()</li>
</ul>
<p>取得被load到JVM的所有class</p>
<ul>
<li>void retransformClasses(Class&lt;?&gt;… classes) throws UnmodifiableClassException</li>
</ul>
<p>針對已經loaded的classes重新在instrumentation機制由agent調整bytecode</p>
<h4 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h4><h5 id="MANIFEST-MF"><a href="#MANIFEST-MF" class="headerlink" title="MANIFEST.MF"></a>MANIFEST.MF</h5><p>也可以用maven build file去產生，我選擇自己寫，然後在maven build file設定使用自己寫的MANIFEST.MF。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Premain-Class: main.AgentMain</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br></pre></td></tr></table></figure>

<p>maven build file相關設定方式見Maven Assembly Plugin。</p>
<h5 id="Maven-Assembly-Plugin"><a href="#Maven-Assembly-Plugin" class="headerlink" title="Maven Assembly Plugin"></a>Maven Assembly Plugin</h5><p>因為有ASM的依賴，所以打包jar的時候要連同依賴的library一起包進去才行。以前都用copy reference，改用assembly plugin做看看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;maven-assembly-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;version&gt;$&#123;maven-assembly-plugin.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">  &lt;configuration&gt;</span><br><span class="line">    &lt;archive&gt;</span><br><span class="line">      &lt;manifestFile&gt;src&#x2F;main&#x2F;resources&#x2F;META-INF&#x2F;MANIFEST.MF&lt;&#x2F;manifestFile&gt;</span><br><span class="line">    &lt;&#x2F;archive&gt;</span><br><span class="line">    &lt;descriptorRefs&gt;</span><br><span class="line">      &lt;descriptorRef&gt;jar-with-dependencies&lt;&#x2F;descriptorRef&gt;</span><br><span class="line">    &lt;&#x2F;descriptorRefs&gt;</span><br><span class="line">  &lt;&#x2F;configuration&gt;</span><br><span class="line">  &lt;executions&gt;</span><br><span class="line">    &lt;execution&gt;</span><br><span class="line">      &lt;id&gt;make-assembly&lt;&#x2F;id&gt;</span><br><span class="line">      &lt;phase&gt;package&lt;&#x2F;phase&gt;</span><br><span class="line">      &lt;goals&gt;</span><br><span class="line">        &lt;goal&gt;single&lt;&#x2F;goal&gt;</span><br><span class="line">      &lt;&#x2F;goals&gt;</span><br><span class="line">    &lt;&#x2F;execution&gt;</span><br><span class="line">  &lt;&#x2F;executions&gt;</span><br><span class="line">&lt;&#x2F;plugin&gt;</span><br></pre></td></tr></table></figure>

<h4 id="Using-ASM-for-manipulate-bytecode"><a href="#Using-ASM-for-manipulate-bytecode" class="headerlink" title="Using ASM for manipulate bytecode"></a>Using ASM for manipulate bytecode</h4><p>hello project的目的是在我們在意的<strong>類別</strong>裡在意的<strong>method</strong>被呼叫前和呼叫後在Console印個log下來。所以我們要做的事情是寫一個<code>ClassFileTransformer</code>，在這裡使用ASM處理bytecode。然後在<code>premain()</code>裡把我們寫的transformer加進去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClassTransformer</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="string">&quot;app/MyTest&quot;</span>.equals(className)) &#123;</span><br><span class="line">            <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">        &#125;</span><br><span class="line">        ClassReader classReader = <span class="keyword">new</span> ClassReader(classfileBuffer);</span><br><span class="line">        ClassWriter classWriter = <span class="keyword">new</span> ClassWriter(classReader, ClassWriter.COMPUTE_FRAMES | ClassWriter.COMPUTE_MAXS);</span><br><span class="line">        ClassVisitor classVisitor = <span class="keyword">new</span> MyClassVisitor(classWriter);</span><br><span class="line">        classReader.accept(classVisitor, ClassReader.SKIP_FRAMES | ClassReader.SKIP_DEBUG);</span><br><span class="line">        <span class="keyword">return</span> classWriter.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡我們在意的類別是app.MyTest這個類別，所以在transformer裡遇到不在乎的class就把該class的bytecode直接回傳；如果遇到MyTest類別，就透過ASM來處理一下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClassVisitor</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME_CONSTRUCTOR = <span class="string">&quot;&lt;init&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME_MAIN = <span class="string">&quot;main&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Set WhiteList = Collections.unmodifiableSet(Set.of(NAME_CONSTRUCTOR, NAME_MAIN));</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyClassVisitor</span><span class="params">(ClassVisitor classVisitor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(ASM8, classVisitor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String descriptor, String signature, String[] exceptions)</span> </span>&#123;</span><br><span class="line">        MethodVisitor methodVisitor = <span class="keyword">super</span>.visitMethod(access, name, descriptor, signature, exceptions);</span><br><span class="line">        <span class="keyword">if</span>(WhiteList.contains(name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> methodVisitor;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyMethodVisitor(ASM8, methodVisitor, access, name, descriptor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟書上範例不一樣的是我不想看main，所以遇到constructor和main的話就把原本的methodVisitor丟回去不處理，反之則回傳我們新寫的<code>MyMethodVisitor</code>的instance回去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMethodVisitor</span> <span class="keyword">extends</span> <span class="title">AdviceAdapter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">MyMethodVisitor</span><span class="params">(<span class="keyword">int</span> api, MethodVisitor methodVisitor, <span class="keyword">int</span> access, String name, String descriptor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(api, methodVisitor, access, name, descriptor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMethodEnter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMethodEnter();</span><br><span class="line">        mv.visitFieldInsn(Opcodes.GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">        mv.visitLdcInsn(<span class="string">&quot;&gt;&gt;&gt; enter &quot;</span> + <span class="keyword">this</span>.getName());</span><br><span class="line">        mv.visitMethodInsn(Opcodes.INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMethodExit</span><span class="params">(<span class="keyword">int</span> opcode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onMethodExit(opcode);</span><br><span class="line">        mv.visitFieldInsn(Opcodes.GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">        mv.visitLdcInsn(<span class="string">&quot;&gt;&gt;&gt; exit &quot;</span> + <span class="keyword">this</span>.getName());</span><br><span class="line">        mv.visitMethodInsn(Opcodes.INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因為只是要在呼叫前後加一些bytecode進去，就可以利用asm-commons這包裡的<code>AdviceAdapter</code>來幫忙，<code>AdviceAdapter</code>提供了method enter/exit的方法給我們實作就可以達成目的。</p>
<p>這裡就只是很簡單的作出System.out.println(str)這樣的bytecode在原本method bytecode前後。</p>
<p>transformer都寫完就是在agent main裡面加進去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> </span>&#123;</span><br><span class="line">    inst.addTransformer(<span class="keyword">new</span> MyClassTransformer(), <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Cleint"><a href="#Cleint" class="headerlink" title="Cleint"></a>Cleint</h4><p>跟書上的例子一樣</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package app;</span><br><span class="line"></span><br><span class="line">public class MyTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        new MyTest().foo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void foo() &#123;</span><br><span class="line">        bar1();</span><br><span class="line">        bar2();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void bar1() &#123;</span><br><span class="line">        System.out.println(&quot;running bar1...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void bar2() &#123;</span><br><span class="line">        System.out.println(&quot;running bar2...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Execute-it"><a href="#Execute-it" class="headerlink" title="Execute it!!!"></a>Execute it!!!</h4><p>執行方式就是在java指令加上-javaagent your_agent_jar，或參考run.xml裡的run-with-javaagent這個target的內容。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;AGENT_JAR&quot;</span> <span class="attr">value</span>=<span class="string">&quot;agent/target/agent-0.0.1-jar-with-dependencies.jar&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">target</span> <span class="attr">name</span>=<span class="string">&quot;run-with-javaagent&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java</span> <span class="attr">jar</span>=<span class="string">&quot;client/target/client-0.0.1.jar&quot;</span> <span class="attr">fork</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jvmarg</span> <span class="attr">value</span>=<span class="string">&quot;-javaagent:$&#123;AGENT_JAR&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>執行結果如下</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">D:\lab\java-basic\instrumentation\hello-javaagent&gt;ant -f run.xml run-with-javaagent</span><br><span class="line">Buildfile: D:\lab\java-basic\instrumentation\hello-javaagent\run.xml</span><br><span class="line"></span><br><span class="line">run-with-javaagent:</span><br><span class="line">     [java] &gt;&gt;&gt; enter foo</span><br><span class="line">     [java] &gt;&gt;&gt; enter bar1</span><br><span class="line">     [java] running bar1...</span><br><span class="line">     [java] &gt;&gt;&gt; exit bar1</span><br><span class="line">     [java] &gt;&gt;&gt; enter bar2</span><br><span class="line">     [java] running bar2...</span><br><span class="line">     [java] &gt;&gt;&gt; exit bar2</span><br><span class="line">     [java] &gt;&gt;&gt; exit foo</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL</span><br><span class="line">Total time: 0 seconds</span><br></pre></td></tr></table></figure>


<h3 id="hello-attach"><a href="#hello-attach" class="headerlink" title="hello-attach"></a>hello-attach</h3><h4 id="入口-1"><a href="#入口-1" class="headerlink" title="入口"></a>入口</h4><p>入口class我們要提供<code>agentmain()</code>這個方法，需要兩個參數</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span></span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>第一個參數是啟動agent時，可以由命令列給予agent的參數，第二個則是JVM會提供agent class使用的Instrumentation的入口。</p>
<h4 id="Configuration-1"><a href="#Configuration-1" class="headerlink" title="Configuration"></a>Configuration</h4><p>就把原本的Premain-Class換成Agent-Class</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Agent-Class: main.AgentMain</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br></pre></td></tr></table></figure>

<h4 id="Using-ASM-for-manipulate-bytecode-1"><a href="#Using-ASM-for-manipulate-bytecode-1" class="headerlink" title="Using ASM for manipulate bytecode"></a>Using ASM for manipulate bytecode</h4><p><code>agentmain</code>內容，將transform加到instrumentation內之外，還要透過<code>retransformClasses()</code>把目標類別重新transform他們的bytecode。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static void agentmain(String agentArgs, Instrumentation inst) throws UnmodifiableClassException &#123;</span><br><span class="line">    System.out.println(&quot;Agent Running...&quot;);</span><br><span class="line">    inst.addTransformer(new MyClassTransformer(), true);</span><br><span class="line">    Class[] classes &#x3D; inst.getAllLoadedClasses();</span><br><span class="line">    for(Class clz : classes) &#123;</span><br><span class="line">        &#x2F;&#x2F;System.out.println(clz.getName());</span><br><span class="line">        if(clz.getName().equals(&quot;com.example.client.controller.HelloController&quot;)) &#123;</span><br><span class="line">            System.out.println(&quot;Reloading: &quot; + clz.getName());</span><br><span class="line">            inst.retransformClasses(clz);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>後面利用ASM Core API作的事情就跟之前專案類似，就不貼了。</p>
<h4 id="Attach"><a href="#Attach" class="headerlink" title="Attach"></a>Attach</h4><p>使用attach的方式需要target JVM的process id，可以透過jps查詢或者這裡我使用一個簡單的Spring Boot程式當作target，啟動Spring Boot Application預設會把process id吐到Console裡。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Attach agent to pid&quot;</span>);</span><br><span class="line">    String pid = args[<span class="number">0</span>];</span><br><span class="line">    String agent = args[<span class="number">1</span>];</span><br><span class="line">    System.out.println(<span class="string">&quot;pid: &quot;</span> + args[<span class="number">0</span>]);</span><br><span class="line">    System.out.println(<span class="string">&quot;agent: &quot;</span> + agent);</span><br><span class="line">    VirtualMachine vm = VirtualMachine.attach(pid);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        vm.loadAgent(agent);</span><br><span class="line">        System.out.println(<span class="string">&quot;Done.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        vm.detach();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>loadAgent()</code>的路徑是target virtual machine的檔案系統裡的agent jar file路徑。見<a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/14/docs/api/jdk.attach/com/sun/tools/attach/VirtualMachine.html#loadAgent(java.lang.String,java.lang.String)">JavaDoc</a></p>
<h4 id="Cleint-1"><a href="#Cleint-1" class="headerlink" title="Cleint"></a>Cleint</h4><p>用Spring Boot做一個簡單的hello api當作測試的client。可以觀察到agent執行時，agent相關程式印到Console的log會在client執行的Console印出來。</p>
<h4 id="Execute-it-1"><a href="#Execute-it-1" class="headerlink" title="Execute it!!!"></a>Execute it!!!</h4><p>attach agent</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\lab\java-basic\instrumentation\hello-attach\attach&gt;java -jar target\attach-0.0.1.jar 17828 D:\lab\java-basic\instrumentation\hello-attach\agent\targe</span><br><span class="line">t\agent-0.0.1-jar-with-dependencies.jar</span><br><span class="line">Attach agent to pid</span><br><span class="line">pid: 17828</span><br><span class="line">agent: D:\lab\java-basic\instrumentation\hello-attach\agent\target\agent-0.0.1-jar-with-dependencies.jar</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>

<p>Srping boot console after attach agent</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2020-09-14 13:15:00.687  INFO 17828 --- [  restartedMain] com.example.client.ClientApplication     : Started ClientApplication in 2.632 seconds (JVM running for 3.352)</span><br><span class="line">Agent Running...</span><br><span class="line">Reloading: com.example.client.controller.HelloController</span><br><span class="line">&lt;init&gt;</span><br><span class="line">hello</span><br><span class="line">Modify hello()</span><br></pre></td></tr></table></figure>

<p>呼叫hello api之後看到server log會印出我們agent添加的程式碼執行的log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2020-09-14 13:15:00.687  INFO 17828 --- [  restartedMain] com.example.client.ClientApplication     : Started ClientApplication in 2.632 seconds (JVM running for 3.352)</span><br><span class="line">Agent Running...</span><br><span class="line">Reloading: com.example.client.controller.HelloController</span><br><span class="line">&lt;init&gt;</span><br><span class="line">hello</span><br><span class="line">Modify hello()</span><br><span class="line">2020-09-14 13:16:52.757  INFO 17828 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[&#x2F;]       : Initializing Spring DispatcherServlet &#39;dispatcherServlet&#39;</span><br><span class="line">2020-09-14 13:16:52.757  INFO 17828 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet &#39;dispatcherServlet&#39;</span><br><span class="line">2020-09-14 13:16:52.770  INFO 17828 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 13 ms</span><br><span class="line">&gt;&gt;&gt; enter hello</span><br><span class="line">&gt;&gt;&gt; exit hello</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/05/jc-parse-java-source/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terence Chao">
      <meta itemprop="description" content="Java幼幼園">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Expert Beginner">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/05/jc-parse-java-source/" class="post-title-link" itemprop="url">Javac (JC) Parse Java Source</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-09-05 23:26:48" itemprop="dateCreated datePublished" datetime="2020-09-05T23:26:48+08:00">2020-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-09-07 10:13:47" itemprop="dateModified" datetime="2020-09-07T10:13:47+08:00">2020-09-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>再提一次這篇用到的類別大多數在他們source的javadoc都有寫到</p>
<blockquote>
<p>This is NOT part of any supported API. If you write code that depends on this, you do so at your own risk.  This code and its internal interfaces are subject to change or deletion without notice.</p>
</blockquote>
<p>Java沒有使用flex這些工具產生lexer或bison產生parser，選擇自己用java打造lexer和parser。</p>
<h3 id="Scanner"><a href="#Scanner" class="headerlink" title="Scanner"></a>Scanner</h3><p><code>com.sun.tools.javac.parser.Scanner</code>這就是Java的Tokenizer。以下的例子是修改自dive into jvm bytecode一書，修改的原因是因為我練習時使用Java 14跟作者用的應該是不同版本，因此就跟javadoc警語一樣，使用者風險請自行負責。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> compile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.parser.Scanner;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.parser.ScannerFactory;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.parser.Tokens;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.util.Context;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * from dive into jvm bytecode</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParseTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ScannerFactory scannerFactory = ScannerFactory.instance(<span class="keyword">new</span> Context());</span><br><span class="line">        Scanner scanner = scannerFactory.newScanner(<span class="string">&quot;int k = i + j;&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        scanner.nextToken();</span><br><span class="line">        Tokens.Token token = scanner.token();</span><br><span class="line">        <span class="keyword">while</span>(token.kind != Tokens.TokenKind.EOF) &#123;</span><br><span class="line">            <span class="keyword">if</span>(token.kind == Tokens.TokenKind.IDENTIFIER) &#123;</span><br><span class="line">                System.out.print(token.name() + <span class="string">&quot; - &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(token.kind);</span><br><span class="line">            scanner.nextToken();</span><br><span class="line">            token = scanner.token();;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程式執行結果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int</span><br><span class="line">k - token.identifier</span><br><span class="line">&#x3D;</span><br><span class="line">i - token.identifier</span><br><span class="line">+</span><br><span class="line">j - token.identifier</span><br><span class="line">&#39;;&#39;</span><br></pre></td></tr></table></figure>

<h3 id="JavaCompiler"><a href="#JavaCompiler" class="headerlink" title="JavaCompiler"></a>JavaCompiler</h3><p>以下的例子是使用<code>JavaCompiler</code>寫個的程式parse簡單的java source code，走訪AST取得所有的variable。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> compile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.source.tree.Tree;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.main.JavaCompiler;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.main.Option;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.tree.JCTree;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.tree.TreeTranslator;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.util.Context;</span><br><span class="line"><span class="keyword">import</span> com.sun.tools.javac.util.Options;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaCompilerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Context context = <span class="keyword">new</span> Context();</span><br><span class="line">        Options.instance(context).put(Option.ENCODING, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        JavaCompiler compiler = <span class="keyword">new</span> JavaCompiler(context);</span><br><span class="line">        compiler.genEndPos = <span class="keyword">true</span>;</span><br><span class="line">        compiler.keepComments = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span> JCTree.JCCompilationUnit compilationUnit = compiler.parse(<span class="string">&quot;src/main/java/client/User.java&quot;</span>);</span><br><span class="line"></span><br><span class="line">        compilationUnit.defs.stream()</span><br><span class="line">                .forEach(jcTree -&gt; &#123;</span><br><span class="line">                    System.out.println(jcTree.toString());</span><br><span class="line">                    System.out.println(jcTree.getKind());</span><br><span class="line">                    listVariable(jcTree);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">listVariable</span><span class="params">(JCTree tree)</span> </span>&#123;</span><br><span class="line">        tree.accept(<span class="keyword">new</span> TreeTranslator() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitClassDef</span><span class="params">(JCTree.JCClassDecl classDecl)</span> </span>&#123;</span><br><span class="line">                classDecl.defs.stream()</span><br><span class="line">                        .filter(it -&gt; it.getKind().equals(Tree.Kind.VARIABLE))</span><br><span class="line">                        .map(it -&gt; (JCTree.JCVariableDecl) it)</span><br><span class="line">                        .forEach(it -&gt; &#123;</span><br><span class="line">                            System.out.println(it.getName() + <span class="string">&quot;: &quot;</span> + it.getKind() + <span class="string">&quot;: &quot;</span> + it.getType());</span><br><span class="line">                        &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因為<code>@SuppressWarnings("deprecation")</code>的礙眼，參考<code>SimpleJavaFileObject</code>自己實作一個<code>JavaFileObject</code>而做了第二個例子。因為很簡單，我們無法使用<code>SimpleJavaFileObject</code>的建構子。這個類別的建構子是protected，而且看起來沒有static factory method可以簡單的方式產生物件，和使用建構子的類別的方法看起來大多是private method，加上<code>JavaFileObject</code>好像沒很複雜，應該可以做一個簡單版本來測試看看parse tree。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> compile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.Modifier;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.NestingKind;</span><br><span class="line"><span class="keyword">import</span> javax.tools.JavaFileObject;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.nio.CharBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySimpleJavaFileObject</span> <span class="keyword">implements</span> <span class="title">JavaFileObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> URI uri;</span><br><span class="line">    <span class="keyword">private</span> Kind kind;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MySimpleJavaFileObject</span><span class="params">(URI uri)</span> </span>&#123;</span><br><span class="line">        Objects.requireNonNull(uri);</span><br><span class="line">        <span class="keyword">if</span> (uri.getPath() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;URI must have a path: &quot;</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!uri.getPath().toLowerCase().endsWith(Kind.SOURCE.extension)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;Only support SOURCE kind&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.uri = uri;</span><br><span class="line">        <span class="keyword">this</span>.kind = Kind.SOURCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Kind <span class="title">getKind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.kind;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNameCompatible</span><span class="params">(String simpleName, Kind kind)</span> </span>&#123;</span><br><span class="line">        String baseName = simpleName + kind.extension;</span><br><span class="line">        <span class="keyword">return</span> kind.equals(getKind())</span><br><span class="line">                &amp;&amp; (baseName.equals(toUri().getPath())</span><br><span class="line">                || toUri().getPath().endsWith(<span class="string">&quot;/&quot;</span> + baseName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NestingKind <span class="title">getNestingKind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Modifier <span class="title">getAccessLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> URI <span class="title">toUri</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> toUri().getPath();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">openInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OutputStream <span class="title">openOutputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Reader <span class="title">openReader</span><span class="params">(<span class="keyword">boolean</span> ignoreEncodingErrors)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        CharSequence charContent = getCharContent(ignoreEncodingErrors);</span><br><span class="line">        <span class="keyword">if</span> (charContent == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">        <span class="keyword">if</span> (charContent <span class="keyword">instanceof</span> CharBuffer) &#123;</span><br><span class="line">            CharBuffer buffer = (CharBuffer)charContent;</span><br><span class="line">            <span class="keyword">if</span> (buffer.hasArray())</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> CharArrayReader(buffer.array());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StringReader(charContent.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CharSequence <span class="title">getCharContent</span><span class="params">(<span class="keyword">boolean</span> ignoreEncodingErrors)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Path path = Paths.get(<span class="keyword">this</span>.uri);</span><br><span class="line"></span><br><span class="line">        Stream&lt;String&gt; lines = Files.lines(path);</span><br><span class="line">        String data = lines.collect(Collectors.joining(<span class="string">&quot;\n&quot;</span>));</span><br><span class="line">        lines.close();</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Writer <span class="title">openWriter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OutputStreamWriter(openOutputStream());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getLastModified</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">接著就可以寫第二個測試，跟第一個只有差一行就不貼全部程式碼</span><br><span class="line"></span><br><span class="line">``` java</span><br><span class="line">JCTree.JCCompilationUnit compilationUnit = compiler.parse(<span class="keyword">new</span> MySimpleJavaFileObject(URI.create(<span class="string">&quot;file:///D:/lab/learning-jvm/src/main/java/client/User.java&quot;</span>)));</span><br></pre></td></tr></table></figure>

<p>忽略把User.java的<code>JCTree</code>印出來，程式執行結果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CLASS</span><br><span class="line">id: VARIABLE: Long</span><br><span class="line">name: VARIABLE: String</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/02/jc-cookbook-introduce-attribute/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terence Chao">
      <meta itemprop="description" content="Java幼幼園">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Expert Beginner">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/02/jc-cookbook-introduce-attribute/" class="post-title-link" itemprop="url">Javac (JC) Cookbook - How to introduce new attribute into exist class</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-09-02 23:50:40" itemprop="dateCreated datePublished" datetime="2020-09-02T23:50:40+08:00">2020-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-09-03 14:48:14" itemprop="dateModified" datetime="2020-09-03T14:48:14+08:00">2020-09-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h3><p>對已經存在的類別加入新的attribute</p>
<h3 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h3><p>作法是透過<code>TreeMaker#VerDef()</code>來產生新的variable的定義，然後透過<code>JCClassDecl</code>的<code>defs#prepend()</code>加到類別的Class Tree上。</p>
<p>以下是使用<code>TreeMaker#VerDef()</code>產生<code>serialVersionUID</code>的定義和初始化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> JCTree.<span class="function">JCVariableDecl <span class="title">genSerialVersionUIDVariable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JCTree.JCModifiers modifiers = treeMaker.Modifiers(PRIVATE + STATIC + FINAL);</span><br><span class="line">    Name id = names.fromString(<span class="string">&quot;serialVersionUID&quot;</span>);</span><br><span class="line">    JCTree.JCExpression varType = treeMaker.Type(<span class="keyword">new</span> Type.JCPrimitiveType(TypeTag.LONG, <span class="keyword">null</span>));</span><br><span class="line">    JCTree.JCExpression init = treeMaker.Literal(<span class="number">1L</span>);</span><br><span class="line">    <span class="keyword">return</span> treeMaker.VarDef(modifiers, id, varType, init);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是把VariableTree加到ClassTree的寫法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jcClassDecl.defs = jcClassDecl.defs.prepend(genSerialVersionUIDVariable());</span><br></pre></td></tr></table></figure>

<p>這個VariableTree對應的java程式碼如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Discussion"><a href="#Discussion" class="headerlink" title="Discussion"></a>Discussion</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/02/jc-cookbook-invoke-constructor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terence Chao">
      <meta itemprop="description" content="Java幼幼園">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Expert Beginner">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/02/jc-cookbook-invoke-constructor/" class="post-title-link" itemprop="url">Javac (JC) Cookbook - How to create instance via invoke default constructor</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-09-02 09:46:09" itemprop="dateCreated datePublished" datetime="2020-09-02T09:46:09+08:00">2020-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-09-03 09:10:40" itemprop="dateModified" datetime="2020-09-03T09:10:40+08:00">2020-09-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>lombok除了JSR 269之外的黑科技。簡單來說lombok是透過Java 6推出的JSR 269 (Pluggable Annotation Processing API)和修改AST這兩個東西，讓我們寫程式更輕鬆。</p>
<p><code>JCTree</code>就是讓我們可以處理Java AST的API。兩件事要先講，首先根據<code>JCTree</code>的JavaDoc寫類別名稱看到JC是javac的縮寫。接著，這些API是internal使用，有可能改變或刪除，如果要用後果自行負責。</p>
<blockquote>
<p>This is NOT part of any supported API. If you write code that depends on this, you do so at your own risk. This code and its internal interfaces are subject to change or deletion without notice.</p>
</blockquote>
<h3 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h3><p>如何透過JCTree API增加一個呼叫default constructor產生物件?</p>
<h3 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h3><p>透過<code>TreeMaker#NewClass()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JCNewClass <span class="title">NewClass</span><span class="params">(JCExpression encl,</span></span></span><br><span class="line"><span class="function"><span class="params">                         List&lt;JCExpression&gt; typeargs,</span></span></span><br><span class="line"><span class="function"><span class="params">                         JCExpression clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">                         List&lt;JCExpression&gt; args,</span></span></span><br><span class="line"><span class="function"><span class="params">                         JCClassDecl def)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SpeculativeNewClass(encl, typeargs, clazz, args, def, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>JCTree</code>可以看到<code>JCNewClass</code>類別。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A new(...) operation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JCNewClass</span> <span class="keyword">extends</span> <span class="title">JCPolyExpression</span> <span class="keyword">implements</span> <span class="title">NewClassTree</span> </span>&#123;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>下面是一個簡單的例子，透過呼叫<code>StringBuilder</code>的default constructor產生一個<code>StringBuilder</code>，後續使用<code>StringBuilder#append(str: String)</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">JCTree.JCExpression varType = query(<span class="string">&quot;java&quot;</span>, <span class="string">&quot;lang&quot;</span>, <span class="string">&quot;StringBuilder&quot;</span>);</span><br><span class="line"></span><br><span class="line">Name result = names.fromString(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">JCTree.JCModifiers resultModifiers = treeMaker.Modifiers(Flags.PARAMETER);</span><br><span class="line"></span><br><span class="line">JCTree.JCNewClass stringBuilderClass = treeMaker.NewClass(<span class="keyword">null</span>,</span><br><span class="line">        com.sun.tools.javac.util.List.nil(),</span><br><span class="line">        varType,</span><br><span class="line">        com.sun.tools.javac.util.List.nil(),</span><br><span class="line">        <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">JCTree.JCVariableDecl resultIdent = treeMaker.VarDef(resultModifiers, result, varType, stringBuilderClass);</span><br></pre></td></tr></table></figure>

<p>對應產生的Java code就是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br></pre></td></tr></table></figure>

<h3 id="Discussion"><a href="#Discussion" class="headerlink" title="Discussion"></a>Discussion</h3><h4 id="Anonymous-class-以Runnable為例"><a href="#Anonymous-class-以Runnable為例" class="headerlink" title="Anonymous class: 以Runnable為例"></a>Anonymous class: 以Runnable為例</h4><p>舉例來說，我們希望在AST裡加上如下列的內容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Runnable r = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>就會使用到<code>TreeMaker#NewClass()</code>的第五個參數。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">JCTree.JCExpression runnableType = query(<span class="string">&quot;java&quot;</span>, <span class="string">&quot;lang&quot;</span>, <span class="string">&quot;Runnable&quot;</span>);</span><br><span class="line"></span><br><span class="line">Name runnable = names.fromString(<span class="string">&quot;r&quot;</span>);</span><br><span class="line">JCTree.JCModifiers rModifiers = treeMaker.Modifiers(Flags.PARAMETER);</span><br><span class="line">ListBuffer&lt;JCTree.JCStatement&gt; runStatements = <span class="keyword">new</span> ListBuffer&lt;&gt;();</span><br><span class="line">JCTree.JCBlock rBody = treeMaker.Block(<span class="number">0</span>, runStatements.toList());</span><br><span class="line"></span><br><span class="line">JCTree.JCMethodDecl runMethod = treeMaker.MethodDef(</span><br><span class="line">        treeMaker.Modifiers(PUBLIC),</span><br><span class="line">        names.fromString(<span class="string">&quot;run&quot;</span>),</span><br><span class="line">        treeMaker.Type(<span class="keyword">new</span> Type.JCVoidType()),</span><br><span class="line">        com.sun.tools.javac.util.List.nil(),</span><br><span class="line">        com.sun.tools.javac.util.List.nil(),</span><br><span class="line">        com.sun.tools.javac.util.List.nil(),</span><br><span class="line">        rBody,</span><br><span class="line">        <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">List&lt;JCTree&gt; defs = List.of(runMethod);</span><br><span class="line"></span><br><span class="line">JCTree.JCClassDecl classDecl = treeMaker.AnonymousClassDef(treeMaker.Modifiers(PARAMETER),</span><br><span class="line">        defs);</span><br><span class="line"></span><br><span class="line">JCTree.JCNewClass rClass = treeMaker.NewClass(<span class="keyword">null</span>,</span><br><span class="line">        com.sun.tools.javac.util.List.nil(),</span><br><span class="line">        runnableType,</span><br><span class="line">        com.sun.tools.javac.util.List.nil(),</span><br><span class="line">        classDecl);</span><br><span class="line"></span><br><span class="line">JCTree.JCVariableDecl rIdent = treeMaker.VarDef(rModifiers, runnable, runnableType, rClass);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/25/java-method-overloading-extra-story/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terence Chao">
      <meta itemprop="description" content="Java幼幼園">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Expert Beginner">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/25/java-method-overloading-extra-story/" class="post-title-link" itemprop="url">Java Method Overloading Extra Story</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-08-25 16:36:40" itemprop="dateCreated datePublished" datetime="2020-08-25T16:36:40+08:00">2020-08-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-09-02 10:09:01" itemprop="dateModified" datetime="2020-09-02T10:09:01+08:00">2020-09-02</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>很久沒寫東西，其實我不知道面試問這個的意義。是要考倒求職者彰顯自己的能力?還是甚麼目的?<br>真的面試到Java那麼熟的碼農，大多數台灣企業做的東西用的上這些知識又有幾間? 公司又能花多少錢養這種工程師，但大多數時間只需要寫CRUD，稍微進階點的東西要做當官的就龜縮? XD</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Method-Overloading"><a href="#Method-Overloading" class="headerlink" title="Method Overloading"></a>Method Overloading</h3><p>Java 101教我們的Method Overloading機制允許我們在一個Java class裡可以有多個相同method name的methods，但argument list必須不一樣。</p>
<p>也就是說如果只有return type不一樣就不行，試著寫下列程式在compile(通常IDE就會給你紅色波浪)的時候就會發生錯誤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMethodOverload</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Terminal編譯的話會看到下列的錯誤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PS D:\tmp&gt; javac .\TestMethodOverload.java</span><br><span class="line">.\TestMethodOverload.java:6: error: method test() is already defined in class TestMethodOverload</span><br><span class="line">    public int test() &#123;</span><br><span class="line">               ^</span><br><span class="line">1 error</span><br></pre></td></tr></table></figure>

<h3 id="Extra-Story"><a href="#Extra-Story" class="headerlink" title="Extra Story"></a>Extra Story</h3><p>問題來了，如果同一個類別裡，有兩個同名的方法，argument list一樣，只有回傳型態不一樣，在JVM是合法的嗎?</p>
<p>答案是【是合法的】，JVM是允許有這樣的情況，method overloading這樣的規定是Java語言的規範，所以是java compiler會抱怨你這樣寫，但是如果你能產生這種情況的bytecode class，JVM是不在乎的。</p>
<p>證明下面這個例子，用BCEL產生一個簡單的Java Class，HelloJVM類別裡面有兩個test1()只有return type的差異，一個回int一個回double。然後順便弄個main method讓我們可已執行一下這兩個test1()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String ClassName = <span class="string">&quot;HelloJVM&quot;</span>;</span><br><span class="line">ClassGen classGen = <span class="keyword">new</span> ClassGen(ClassName,</span><br><span class="line">        <span class="string">&quot;java.lang.Object&quot;</span>,</span><br><span class="line">        <span class="string">&quot;&lt;generated&gt;&quot;</span>,</span><br><span class="line">        Constants.ACC_PUBLIC | Constants.ACC_SUPER,</span><br><span class="line">        <span class="keyword">null</span>);</span><br><span class="line">ConstantPoolGen constantPoolGen = classGen.getConstantPool();</span><br><span class="line">InstructionList instructionList = <span class="keyword">new</span> InstructionList();</span><br><span class="line">InstructionFactory instructionFactory = <span class="keyword">new</span> InstructionFactory(classGen);</span><br><span class="line"></span><br><span class="line">MethodGen test1MethodGen = <span class="keyword">new</span> MethodGen(Constants.ACC_PUBLIC,</span><br><span class="line">        Type.INT,</span><br><span class="line">        Type.NO_ARGS,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">&quot;test1&quot;</span>,</span><br><span class="line">        ClassName,</span><br><span class="line">        instructionList,</span><br><span class="line">        constantPoolGen);</span><br><span class="line">instructionList.append(<span class="keyword">new</span> PUSH(constantPoolGen, <span class="number">5</span>));</span><br><span class="line">instructionList.append(InstructionFactory.createReturn(Type.INT));</span><br><span class="line"></span><br><span class="line">test1MethodGen.setMaxLocals();</span><br><span class="line">test1MethodGen.setMaxStack();</span><br><span class="line">classGen.addMethod(test1MethodGen.getMethod());</span><br><span class="line">instructionList.dispose();</span><br><span class="line"></span><br><span class="line">MethodGen test2MethodGen = <span class="keyword">new</span> MethodGen(Constants.ACC_PUBLIC,</span><br><span class="line">        Type.DOUBLE,</span><br><span class="line">        Type.NO_ARGS,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">&quot;test1&quot;</span>,</span><br><span class="line">        ClassName,</span><br><span class="line">        instructionList,</span><br><span class="line">        constantPoolGen);</span><br><span class="line">instructionList.append(<span class="keyword">new</span> PUSH(constantPoolGen, <span class="number">10.112</span>));</span><br><span class="line">instructionList.append(InstructionFactory.createReturn(Type.DOUBLE));</span><br><span class="line"></span><br><span class="line">test2MethodGen.setMaxLocals();</span><br><span class="line">test2MethodGen.setMaxStack();</span><br><span class="line">classGen.addMethod(test2MethodGen.getMethod());</span><br><span class="line">instructionList.dispose();</span><br><span class="line"></span><br><span class="line">MethodGen mainMethodGen = <span class="keyword">new</span> MethodGen(Constants.ACC_PUBLIC | Constants.ACC_STATIC,</span><br><span class="line">        Type.VOID,</span><br><span class="line">        <span class="keyword">new</span> Type[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ArrayType(Type.STRING, <span class="number">1</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">new</span> String[] &#123;<span class="string">&quot;argv&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;main&quot;</span>,</span><br><span class="line">        ClassName,</span><br><span class="line">        instructionList,</span><br><span class="line">        constantPoolGen);</span><br><span class="line">ObjectType p_stream = <span class="keyword">new</span> ObjectType(<span class="string">&quot;java.io.PrintStream&quot;</span>);</span><br><span class="line"></span><br><span class="line">instructionList.append(instructionFactory.createNew(ClassName));</span><br><span class="line">instructionList.append(InstructionFactory.createDup(<span class="number">1</span>));</span><br><span class="line">instructionList.append(instructionFactory.createInvoke(ClassName,</span><br><span class="line">        <span class="string">&quot;&lt;init&gt;&quot;</span>,</span><br><span class="line">        Type.VOID,</span><br><span class="line">        <span class="keyword">new</span> Type[] &#123;&#125;,</span><br><span class="line">        (<span class="keyword">short</span>) Constants.INVOKESPECIAL));</span><br><span class="line">instructionList.append(InstructionFactory.createStore(Type.OBJECT, <span class="number">1</span>));</span><br><span class="line">instructionList.append(instructionFactory.createFieldAccess(<span class="string">&quot;java.lang.System&quot;</span>,</span><br><span class="line">        <span class="string">&quot;out&quot;</span>,</span><br><span class="line">        p_stream,</span><br><span class="line">        (<span class="keyword">short</span>) Constants.GETSTATIC));</span><br><span class="line">instructionList.append(InstructionFactory.createLoad(Type.OBJECT, <span class="number">1</span>));</span><br><span class="line">instructionList.append(instructionFactory.createInvoke(ClassName,</span><br><span class="line">        <span class="string">&quot;test1&quot;</span>,</span><br><span class="line">        Type.INT,</span><br><span class="line">        Type.NO_ARGS,</span><br><span class="line">        (<span class="keyword">short</span>) Constants.INVOKEVIRTUAL));</span><br><span class="line">instructionList.append(instructionFactory.createInvoke(<span class="string">&quot;java.io.PrintStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;println&quot;</span>,</span><br><span class="line">        Type.VOID,</span><br><span class="line">        <span class="keyword">new</span> Type[] &#123;Type.INT&#125;,</span><br><span class="line">        (<span class="keyword">short</span>) Constants.INVOKEVIRTUAL));</span><br><span class="line">instructionList.append(instructionFactory.createFieldAccess(<span class="string">&quot;java.lang.System&quot;</span>,</span><br><span class="line">        <span class="string">&quot;out&quot;</span>,</span><br><span class="line">        p_stream,</span><br><span class="line">        (<span class="keyword">short</span>) Constants.GETSTATIC));</span><br><span class="line">instructionList.append(InstructionFactory.createLoad(Type.OBJECT, <span class="number">1</span>));</span><br><span class="line">instructionList.append(instructionFactory.createInvoke(ClassName,</span><br><span class="line">        <span class="string">&quot;test1&quot;</span>,</span><br><span class="line">        Type.DOUBLE,</span><br><span class="line">        Type.NO_ARGS,</span><br><span class="line">        (<span class="keyword">short</span>) Constants.INVOKEVIRTUAL));</span><br><span class="line">instructionList.append(instructionFactory.createInvoke(<span class="string">&quot;java.io.PrintStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;println&quot;</span>,</span><br><span class="line">        Type.VOID,</span><br><span class="line">        <span class="keyword">new</span> Type[] &#123;Type.DOUBLE&#125;,</span><br><span class="line">        (<span class="keyword">short</span>) Constants.INVOKEVIRTUAL));</span><br><span class="line"></span><br><span class="line">instructionList.append(InstructionFactory.createReturn(Type.VOID));</span><br><span class="line"></span><br><span class="line">mainMethodGen.setMaxStack();</span><br><span class="line">mainMethodGen.setMaxLocals();</span><br><span class="line">classGen.addMethod(mainMethodGen.getMethod());</span><br><span class="line"></span><br><span class="line">instructionList.dispose();</span><br><span class="line"></span><br><span class="line">classGen.addEmptyConstructor(Constants.ACC_PUBLIC);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    classGen.getJavaClass().dump(<span class="string">&quot;HelloJVM.class&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/tzuyichao/java-basic/blob/master/java-basic/src/main/java/bcel/Test1BCEL.java">完整程式碼</a>，接下來是來執行一下產生的HelloJVM class，順便用javap看一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">D:\lab\java-basic\java-basic&gt;java HelloJVM</span><br><span class="line">5</span><br><span class="line">10.112</span><br><span class="line"></span><br><span class="line">D:\lab\java-basic\java-basic&gt;javap HelloJVM.class</span><br><span class="line">Compiled from &quot;&lt;generated&gt;&quot;</span><br><span class="line">public class HelloJVM &#123;</span><br><span class="line">  public int test1();</span><br><span class="line">  public double test1();</span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">  public HelloJVM();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/25/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Terence Chao">
      <meta itemprop="description" content="Java幼幼園">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Expert Beginner">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/25/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-08-25 13:28:53" itemprop="dateCreated datePublished" datetime="2020-08-25T13:28:53+08:00">2020-08-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Terence Chao</p>
  <div class="site-description" itemprop="description">Java幼幼園</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">標籤</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Terence Chao</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
